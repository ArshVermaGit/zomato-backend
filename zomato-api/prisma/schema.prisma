generator client {
  provider = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
}

// ============= USER MANAGEMENT =============
model User {
  id            String   @id @default(uuid())
  phone         String   @unique
  email         String?  @unique
  name          String
  role          UserRole
  avatar        String?
  isActive      Boolean  @default(true)
  isVerified    Boolean  @default(false)
  passwordHash  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  customer          Customer?
  deliveryPartner   DeliveryPartner?
  restaurantPartner RestaurantPartner?
  addresses         Address[]
  orders            Order[]
  reviews           Review[]
  notifications     Notification[]
  sessions          Session[]
  fcmTokens         String[]


  @@index([phone])
  @@index([email])
  @@index([role])
}

enum UserRole {
  CUSTOMER
  DELIVERY_PARTNER
  RESTAURANT_PARTNER
  ADMIN
}

model Session {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token        String   @unique
  refreshToken String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([token])
}

model Customer {
  id                    String   @id @default(uuid())
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  favoriteRestaurants   String[] // Restaurant IDs
  totalOrders           Int      @default(0)
  totalSpent            Decimal  @default(0) @db.Decimal(10, 2)
  loyaltyPoints         Int      @default(0)
  
  @@index([userId])
}

model DeliveryPartner {
  id                 String          @id @default(uuid())
  userId             String          @unique
  user               User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  vehicleType        VehicleType
  vehicleNumber      String
  licenseNumber      String
  isAvailable        Boolean         @default(false)
  isOnline           Boolean         @default(false)
  currentLocation    Json?           // { lat, lng, heading }
  documentsVerified  Boolean         @default(false)
  onboardingStatus   OnboardingStatus @default(PENDING)
  bankDetails        Json?           // { accountNumber, ifsc, bankName }
  emergencyContact   Json?           // { name, phone, relation }
  rating             Decimal         @default(0) @db.Decimal(3, 2)
  totalDeliveries    Int             @default(0)
  totalEarnings      Decimal         @default(0) @db.Decimal(10, 2)
  
  // ... existing fields ...
  availableBalance   Decimal         @default(0) @db.Decimal(10, 2)

  orders             Order[]
  documents          Document[]
  earnings           Earning[]
  payouts            Payout[]
  payoutRequests     PayoutRequest[]
  walletTransactions WalletTransaction[]
  
  @@index([userId])
  @@index([isAvailable, isOnline])
}

// ... existing enums ...

model Report {
  id        String   @id @default(uuid())
  type      ReportType
  period    String   // "daily", "weekly", "monthly"
  data      Json
  status    ReportStatus @default(PENDING)
  generatedBy String?
  url       String?
  createdAt DateTime @default(now())
}

enum ReportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum ReportType {
    SALES
    PERFORMANCE
    USER_GROWTH
    USERS // Added for compatibility if needed, or remove Code usage
}


enum OnboardingStatus {
  PENDING
  DOCUMENTS_UPLOADED
  VERIFIED
  REJECTED
}

enum VehicleType {
  BIKE
  SCOOTER
  BICYCLE
  CAR
}

model RestaurantPartner {
  id          String       @id @default(uuid())
  userId      String       @unique
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  restaurants Restaurant[]
  
  @@index([userId])
}

// ============= RESTAURANT MANAGEMENT =============
model Restaurant {
  id              String              @id @default(uuid())
  name            String
  description     String?
  cuisineTypes    String[]
  phone           String
  email           String
  location        Json                // { lat, lng, address, landmark }
  isActive        Boolean             @default(true)
  isOpen          Boolean             @default(false)
  rating          Decimal             @default(0) @db.Decimal(3, 2)
  totalRatings    Int                 @default(0)
  preparationTime Int                 @default(30) // minutes
  minimumOrder    Decimal             @default(0) @db.Decimal(10, 2)
  deliveryFee     Decimal             @db.Decimal(10, 2)
  deliveryRadius  Decimal             @default(5) @db.Decimal(5, 2) // km
  images          String[]
  coverImage      String?
  partnerId       String
  partner         RestaurantPartner   @relation(fields: [partnerId], references: [id])
  
  menuCategories  MenuCategory[]
  orders          Order[]
  reviews         Review[]
  operatingHours  OperatingHours[]
  
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([partnerId])
  @@index([isActive, isOpen])
  @@index([location]) // GiST index for geospatial queries
}

model OperatingHours {
  id           String     @id @default(uuid())
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  dayOfWeek    Int        // 0 = Sunday, 6 = Saturday
  openTime     String     // "09:00"
  closeTime    String     // "22:00"
  isClosed     Boolean    @default(false)

  @@unique([restaurantId, dayOfWeek])
  @@index([restaurantId])
}

model MenuCategory {
  id           String     @id @default(uuid())
  name         String
  description  String?
  displayOrder Int        @default(0)
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  items        MenuItem[]
  isActive     Boolean    @default(true)

  @@index([restaurantId])
  @@index([displayOrder])
}

model MenuItem {
  id           String         @id @default(uuid())
  name         String
  description  String
  price        Decimal        @db.Decimal(10, 2)
  images       String[]
  isVeg        Boolean        @default(true)
  isAvailable  Boolean        @default(true)
  isBestseller Boolean        @default(false)
  categoryId   String
  category     MenuCategory   @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  modifiers    MenuModifier[]
  orderItems   OrderItem[]

  @@index([categoryId])
  @@index([isAvailable])
}

model MenuModifier {
  id         String   @id @default(uuid())
  name       String   // "Size", "Toppings"
  options    Json[]   // [{ name: "Large", price: 50, isDefault: false }]
  isRequired Boolean  @default(false)
  minSelect  Int      @default(0)
  maxSelect  Int      @default(1)
  menuItemId String
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)

  @@index([menuItemId])
}

// ============= ORDER MANAGEMENT =============
model Order {
  id                   String        @id @default(uuid())
  orderNumber          String        @unique
  status               OrderStatus   @default(PENDING)
  
  customerId           String
  customer             User          @relation(fields: [customerId], references: [id])
  
  restaurantId         String
  restaurant           Restaurant    @relation(fields: [restaurantId], references: [id])
  
  deliveryPartnerId    String?
  deliveryPartner      DeliveryPartner? @relation(fields: [deliveryPartnerId], references: [id])
  
  items                OrderItem[]
  
  deliveryAddress      Json          // Full address object
  customerInstructions String?
  
  // Pricing
  itemsTotal           Decimal       @db.Decimal(10, 2)
  deliveryFee          Decimal       @db.Decimal(10, 2)
  taxes                Decimal       @db.Decimal(10, 2)
  platformFee          Decimal       @default(0) @db.Decimal(10, 2)
  discount             Decimal       @default(0) @db.Decimal(10, 2)
  tip                  Decimal       @default(0) @db.Decimal(10, 2)
  totalAmount          Decimal       @db.Decimal(10, 2)
  
  paymentMethod        PaymentMethod
  paymentStatus        PaymentStatus @default(PENDING)
  paymentTransactionId String?
  paymentTransactions  PaymentTransaction[] // Relation
  refunds              Refund[]

  
  // Timestamps
  placedAt             DateTime      @default(now())
  acceptedAt           DateTime?
  preparingAt          DateTime?
  readyAt              DateTime?
  pickedUpAt           DateTime?
  deliveredAt          DateTime?
  cancelledAt          DateTime?
  
  // OTPs
  pickupOTP            String?
  deliveryOTP          String?
  
  // Tracking
  estimatedDeliveryTime Int?        // minutes
  actualDeliveryTime    Int?
  
  rating               Int?
  review               Review?
  
  promoCode            String?
  
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt

  @@index([customerId])
  @@index([restaurantId])
  @@index([deliveryPartnerId])
  @@index([status])
  @@index([placedAt])
  @@index([orderNumber])
}

enum OrderStatus {
  PENDING
  ACCEPTED
  PREPARING
  READY
  PICKED_UP
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
}

enum PaymentMethod {
  CARD
  UPI
  WALLET
  CASH_ON_DELIVERY
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model OrderItem {
  id                  String   @id @default(uuid())
  orderId             String
  order               Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  menuItemId          String
  menuItem            MenuItem @relation(fields: [menuItemId], references: [id])
  quantity            Int
  price               Decimal  @db.Decimal(10, 2)
  selectedModifiers   Json?    // { modifierId, optionName, price }
  specialInstructions String?

  @@index([orderId])
  @@index([menuItemId])
}

// ============= REVIEWS & RATINGS =============
model Review {
  id           String     @id @default(uuid())
  orderId      String     @unique
  order        Order      @relation(fields: [orderId], references: [id])
  userId       String
  user         User       @relation(fields: [userId], references: [id])
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])
  rating       Int        // 1-5
  deliveryRating Int?     // 1-5 for delivery partner
  comment      String?
  images       String[]
  tags         String[]
  response     String?    // Restaurant response
  respondedAt  DateTime?
  helpfulCount Int        @default(0)
  isReported   Boolean    @default(false)
  createdAt    DateTime   @default(now())

  @@index([orderId])
  @@index([userId])
  @@index([restaurantId])
}

// ============= ADDRESS MANAGEMENT =============
model Address {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  label       String   // Home, Work, Other
  fullAddress String
  location    Json     // { lat, lng }
  landmark    String?
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@index([userId])
}

// ============= PROMO & COUPONS =============
model Promo {
  id             String       @id @default(uuid())
  code           String       @unique
  description    String
  discountType   DiscountType
  discountValue  Decimal      @db.Decimal(10, 2)
  minOrderValue  Decimal      @db.Decimal(10, 2)
  maxDiscount    Decimal?     @db.Decimal(10, 2)
  validFrom      DateTime
  validUntil     DateTime
  usageLimit     Int?
  usedCount      Int          @default(0)
  maxUsagePerUser Int?
  isNewUserOnly  Boolean      @default(false)
  isActive       Boolean      @default(true)
  applicableFor  String[]     // ["all", "new_users", "specific_restaurants"]
  applicableRestaurantIds String[] // IDs for specific restaurants
  
  @@index([code])
  @@index([isActive])
}

enum DiscountType {
  PERCENTAGE
  FIXED
  FREE_DELIVERY
}

// ============= PAYMENT TRANSACTIONS =============
model PaymentTransaction {
  id                  String        @id @default(uuid())
  orderId             String?
  amount              Decimal       @db.Decimal(10, 2)
  method              PaymentMethod
  status              PaymentStatus
  gatewayTransactionId String?
  gatewayResponse     Json?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  
  order               Order?        @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([status])
}

model Refund {
  id                String       @id @default(uuid())
  orderId           String
  order             Order        @relation(fields: [orderId], references: [id])
  amount            Decimal      @db.Decimal(10, 2)
  reason            String?
  status            RefundStatus @default(PENDING)
  gatewayRefundId   String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@index([orderId])
}

enum RefundStatus {
  PENDING
  PROCESSED
  FAILED
}

// ============= DELIVERY PARTNER DOCUMENTS =============
model Document {
  id                String          @id @default(uuid())
  deliveryPartnerId String
  deliveryPartner   DeliveryPartner @relation(fields: [deliveryPartnerId], references: [id], onDelete: Cascade)
  type              DocumentType
  fileUrl           String
  status            DocumentStatus  @default(PENDING)
  rejectionReason   String?
  uploadedAt        DateTime        @default(now())
  verifiedAt        DateTime?

  @@index([deliveryPartnerId])
  @@index([status])
}

enum DocumentType {
  PROFILE_PHOTO
  DRIVERS_LICENSE_FRONT
  DRIVERS_LICENSE_BACK
  AADHAAR_FRONT
  AADHAAR_BACK
  VEHICLE_RC
  BANK_PROOF
}

enum DocumentStatus {
  PENDING
  APPROVED
  REJECTED
}

// ============= EARNINGS & PAYOUTS =============
model Earning {
  id                String          @id @default(uuid())
  deliveryPartnerId String
  deliveryPartner   DeliveryPartner @relation(fields: [deliveryPartnerId], references: [id])
  orderId           String?
  type              EarningType
  amount            Decimal         @db.Decimal(10, 2)
  description       String?
  createdAt         DateTime        @default(now())

  @@index([deliveryPartnerId])
  @@index([createdAt])
}

enum EarningType {
  DELIVERY_FEE
  TIP
  DISTANCE_BONUS
  PEAK_HOUR_BONUS
  INCENTIVE
  ADJUSTMENT
}

model Payout {
  id                String          @id @default(uuid())
  deliveryPartnerId String
  deliveryPartner   DeliveryPartner @relation(fields: [deliveryPartnerId], references: [id])
  amount            Decimal         @db.Decimal(10, 2)
  fee               Decimal         @default(0) @db.Decimal(10, 2)
  netAmount         Decimal         @db.Decimal(10, 2)
  status            PayoutStatus    @default(PENDING)
  method            PayoutMethod
  transactionId     String?
  requestedAt       DateTime        @default(now())
  processedAt       DateTime?

  @@index([deliveryPartnerId])
  @@index([status])
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REJECTED
  PROCESSED
}

enum PayoutMethod {
  DAILY_AUTO
  INSTANT
}

// ============= NOTIFICATIONS =============
model Notification {
  id        String           @id @default(uuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      NotificationType
  title     String
  message   String
  data      Json?            // Additional data
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

enum NotificationType {
  ORDER_PLACED
  ORDER_ACCEPTED
  ORDER_PREPARING
  ORDER_READY
  ORDER_PICKED_UP
  ORDER_DELIVERED
  ORDER_CANCELLED
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  PROMO_AVAILABLE
  DELIVERY_PARTNER_NEARBY
  REVIEW_RECEIVED
  PAYOUT_COMPLETED
}

model PayoutRequest {
  id                String    @id @default(uuid())
  deliveryPartnerId String
  deliveryPartner   DeliveryPartner @relation(fields: [deliveryPartnerId], references: [id])
  amount            Decimal   @db.Decimal(10, 2)
  status            PayoutStatus @default(PENDING)
  processedAt       DateTime?
  referenceId       String?   // Bank reference
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([deliveryPartnerId])
}



model WalletTransaction {
  id                String    @id @default(uuid())
  deliveryPartnerId String
  deliveryPartner   DeliveryPartner @relation(fields: [deliveryPartnerId], references: [id])
  amount            Decimal   @db.Decimal(10, 2)
  type              WalletTransactionType
  description       String?
  createdAt         DateTime  @default(now())

  @@index([deliveryPartnerId])
}

enum WalletTransactionType {
  CREDIT
  DEBIT
}
